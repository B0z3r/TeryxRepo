{% extends 'app/base.html' %}
{% load static %}
{% block contenido %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.0.2/dist/chart.min.css">
<link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
<script src="//code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.11.6/datatables.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.9/css/buttons.dataTables.min.css"/>

<script>
  $(document).ready(function () {
      // Verifica si ya existe una tabla DataTable y la destruye antes de volver a inicializarla
      if ($.fn.DataTable.isDataTable('#example')) {
          $('#example').DataTable().destroy();
      }
  
      $('#example').DataTable({
          "language": {
              "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
          },
          dom: 'lBfrtip', // Incluye 'l' para mostrar el selector de longitud de página
          lengthMenu: [[10, 20, 50, -1], [10, 20, 50, "Todos"]], // Configura las opciones del selector
          buttons: [
              {
                  extend: 'excelHtml5',
                  text: '<i class="fa fa-file-excel-o"></i>',
                  titleAttr: 'Excel',
                  className: 'btn-success',
                  title: 'Historial talleres atrasados',
                  pageSize: 'LEGAL',
                  exportOptions: {
                      columns: ':visible:not(:last-child)'
                  },
              },
              {
                  extend: 'csvHtml5',
                  text: '<i class="fa fa-file-text-o"></i>',
                  titleAttr: 'CSV',
                  className: 'btn-info',
                  title: 'Historial talleres atrasados',
                  pageSize: 'LEGAL',
                  exportOptions: {
                      columns: ':visible:not(:last-child)'
                  },
              },
              {
                  extend: 'pdfHtml5',
                  text: '<i class="fa fa-file-pdf-o"></i>',
                  titleAttr: 'PDF',
                  className: 'btn-danger',
                  title: 'Historial talleres atrasados',
                  pageSize: 'LEGAL',
                  exportOptions: {
                      columns: ':visible:not(:last-child)'
                  },
              },
              {
                  extend: 'print',
                  text: '<i class="fa fa-solid fa-print"></i>',
                  titleAttr: 'Imprimir',
                  title: 'Historial talleres atrasados',
                  className: 'btn-secondary',
                  exportOptions: {
                      columns: ':visible:not(:last-child)'
                  },
              },
          ],
          customize: function (win) {
              $(win.document.body).find('#example').css({
                  'transform': 'rotate(-90deg)',
                  'transform-origin': 'left top',
                  'white-space': 'nowrap'
              });
          }
      });
  });
  </script>
  

<!-- offcanvas -->
<main class="mt-5 pt-3" style="background-color: #efefef;">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12" style="padding-bottom: 30px; padding-top: 30px; text-align: center; ">
        <h2>Bievenido a teryx {{ user.username }} </h2>
      </div>
    </div>
    <div class="card" style="border-radius: 20px; background: #ffffff; padding: 20px; box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.1);">
      <div class="row">
          <!-- COUNT DE CLIENTES -->
          <div class="col-md-3 mb-3">
              <div class="card text-white" style="border-radius: 20px; background: #216869; height: 100%;">
                  <div class="card-body d-flex flex-column justify-content-center align-items-center py-5">
                      <p style="font-size: 20px;">Total de Clientes</p>
                      <p class="bi bi-people-fill" style="font-size: 40px;">{{ total_clientes }}</p>
                  </div>
                  <a class="card-footer d-flex justify-content-center" href="{% url 'listar_cliente'%}"
                      style="color: rgb(255, 255, 255); text-decoration: none; border-radius: 15px; border-color: transparent;">Listado de Clientes</a>
              </div>
          </div>
  
          <!-- COUNT DE PROVEEDORES -->
          <div class="col-md-3 mb-3">
              <div class="card text-white" style="border-radius: 20px; background: #629460; height: 100%;">
                  <div class="card-body d-flex flex-column justify-content-center align-items-center py-5">
                      <p style="font-size: 20px;">Total de Proveedores</p>
                      <p class="bi bi-person-bounding-box" style="font-size: 40px;">{{ total_proveedores }}</p>
                  </div>
                  <a class="card-footer d-flex justify-content-center" href="{% url 'listar_proveedor'%}"
                      style="color: rgb(255, 255, 255); text-decoration: none; border-radius: 15px; border-color: transparent;">Listado de Proveedores</a>
              </div>
          </div>
  
          <!-- COUNT DE PRODUCTOS -->
          <div class="col-md-3 mb-3">
              <div class="card text-white" style="border-radius: 20px; background: #9D5C63; height: 100%;">
                  <div class="card-body d-flex flex-column justify-content-center align-items-center py-5">
                      <p style="font-size: 20px;">Total de Productos</p>
                      <p class="bi bi-basket2" style="font-size: 40px;">{{ total_productos }}</p>
                  </div>
                  <a class="card-footer d-flex justify-content-center" href="{% url 'listar_producto'%}"
                      style="color: rgb(255, 255, 255); text-decoration: none; border-radius: 15px; border-color: transparent;">Listado de Productos</a>
              </div>
          </div>
  
          <!-- COUNT DE AGENDAMIENTOS -->
          <div class="col-md-3 mb-3">
              <div class="card text-white" style="border-radius: 20px; background:#ba542b; height: 100%;">
                  <div class="card-body d-flex flex-column justify-content-center align-items-center py-5">
                      <p style="font-size: 20px;">Total de Agendamiento</p>
                      <p class="bi bi-list-task" style="font-size: 40px;">{{ total_talleres }}</p>
                  </div>
                  <a class="card-footer d-flex justify-content-center" href="{% url 'list_taller'%}"
                      style="color: rgb(255, 255, 255); text-decoration: none; border-radius: 15px; border-color: transparent;">Listado de Agendamientos</a>
              </div>
          </div>
      </div>
  </div>
  <hr>
  
  
    <!--PRODUCTOS QUE TIENEN UN STOCK <5-->
      <div class="row">
        <div class="col-md-6">
          <div class="card" style="border-radius: 20px; background: #ffffff; padding: 20px; box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.1); padding-bottom: 70px;">
              <div class="card-body">
                  <h3 class="card-title">Productos con Stock menor a 5 unidades</h3>
                  <table class="table table-striped table-hover">
                      <thead>
                          <tr style="background-color:#1b1b1b; color: rgb(235, 232, 232);">
                              <th>Nombre del Producto</th>
                              <th>Stock</th>
                          </tr>
                      </thead>
                      <tbody style="border-radius: 20px;">
                          {% for producto in productos_bajo_stock %}
                          <tr>
                              <td>{{ producto.0 }}</td><!-- este es el nombre del producto-->
                              <td style="{% if producto.1 <= 5 %}color: red;{% endif %}">{{ producto.1 }}</td><!-- este es el stock-->
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
          </div>
      </div>
      
    
        <div class="col-md-6">
            <div class="card" style="border-radius: 20px; background: #ffffff; padding: 20px; box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.1); padding-bottom: 50px;">
                <div class="card-body">
                    <div id="contenedor">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col">
                                    <table id="exampleGrafico" class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tipo de Pago</th>
                                                <th>Suma de los Totales</th>
                                            </tr>
                                        </thead>
                                        <tbody style="border-radius: 20px;">
                                            {% for tp in suma_totales_por_tipo_pago %}
                                            <tr>
                                                <td>{{ tp.0 }}</td><!-- este es el TIPO DE PAGO-->
                                                <td>{{ tp.1 }}</td><!-- esta es la SUMA DE TOTALES-->
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <script>
        $(document).ready(function () {
            var table = $("#exampleGrafico").DataTable({
                dom: 'Pfrtip', //P para ver el panel de búsqueda
            })
    
            var graf = $('#contenedor');
            var chart = Highcharts.chart(graf[0], {
                chart: {
                    type: 'pie',
                    plotBackgroundColor: 'white',
                    plotBorderWidth: null,
                    plotShadow: false,
                },
                title: {
                    text: 'Gráfico Suma de Totales por Tipo de Pago'
                },
                tooltip: {
                    pointFormat: '{point.name}: <b>{point.y}</b>'
                },
                series: [{
                    data: chartData(table),
                    dataLabels: {
                        enabled: true,
                        formatter: function () {
                            return '<b>' + this.point.name + '</b><br>MONTO: ' + this.point.y.toLocaleString('es-CL', {
                                style: 'currency',
                                currency: 'CLP'
                            });
    
                        },
                        distance: 30, // Aumenta este valor para aumentar la separación entre las etiquetas
                        style: {
                            color: 'black'
                        }
                    }
                }]
            });
    
            table.on('draw', function () {
                chart.series[0].setData(chartData(table));
            });
    
            // Función chartData
            function chartData(table) {
                var datos = [];
    
                table.rows({ search: "applied" }).data().each(function (row) {
                    datos.push({
                        name: row[0], // Tipo de Pago
                        y: parseInt(row[1]), // Suma de los Totales
                        cantidad: row[2], // Otra información que quieras mostrar
                        montoTotal: row[3] // Otra información que quieras mostrar
                    });
                });
    
                return datos;
            }
        });
    </script>
    
<!--AGENDAMIENTOS EN ESTADO ATRASADOS-->
<div class="card" style="border-radius: 20px; margin-top: 30px; margin-bottom: 30px; background: #ffffff; padding: 20px; box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.1);">    
<div class="row">
      <div class="col-md-12 " >
        <div class="card" >
          <div class="card-body">
            <h3 class="card-title">Agendamientos en Estado <span style="color: red;">ATRASADOS</span></h3>
            <div class="table-responsive">
              <table id="example" class="table table-striped-columns table-hover data-table" style="width: 100% ; font-size: 12px;">
                <thead>
                  <tr style="background-color:#1b1b1b ;color: rgb(235, 232, 232);">
                    <th>Nº</th>
                    <th>Datos del Cliente</th>
                    <th>Modelo de Bicicleta</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Término</th>
                  </tr>
                </thead>
                <tbody>
                  {% for taller in talleres_atrasados_estado %}
                    <tr>
                      <td>{{ taller.id_taller }}</td>
                      <td>{{ taller.cliente_rut_cliente.rut_cliente }} - {{ taller.cliente_rut_cliente.nombre_cliente }} {{ taller.cliente_rut_cliente.apePaterno }} {{ taller.cliente_rut_cliente.apeMaterno }}</td>
                      <td>{{ taller.modelo_bicicleta }}</td>
                      <td>{{ taller.fecha_ingreso }}</td>
                      <td> <span style="color: red;">{{ taller.fecha_termino }}</span></td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}


