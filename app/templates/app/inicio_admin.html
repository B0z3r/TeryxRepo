{% extends 'app/base.html' %}
{% load static %}
{% block contenido %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css">
<link rel="stylesheet" href="//code.highcharts.com/css/highcharts.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
<script src="//code.highcharts.com/highcharts.js"></script>

<!-- offcanvas -->
<main class="mt-5 pt-3">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12" style="padding-bottom: 30px; padding-top: 30px; text-align: center; ">
        <h2>Bievenido a teryx {{ user.username }} </h2>
      </div>
    </div>
    <div class="row">
      <!--COUNT DE CLIENTES-->
      <div class="col-md-3 mb-3">
        <div class="card text-white " style="border-radius: 20px; background: #216869">
          <div class="card-body py-5" style="align-content: center; text-align: center;">
            <p style="font-size: 20px;">Total de Clientes</p>
            <p class="bi bi-people-fill d-flex align-items-center justify-content-center" style="font-size: 40px; ">{{ total_clientes }}</p>
          </div>
          <a class="card-footer d-flex justify-content-center " href="{% url 'listar_cliente'%}"
             style="color: rgb(255, 255, 255);  text-decoration: none; border-radius: 15px; border-color: transparent; ">Listado de Clientes</a>
        </div>
      </div>
      <!--COUNT DE PROVEEDORES-->
      <div class="col-md-3 mb-3">
        <div class="card text-white" style="border-radius: 20px; background: #629460">
          <div class="card-body py-5" style="align-content: center; text-align: center;">
            <p style="font-size: 20px;">Total de Proveedores</p>
            <p class="bi bi-person-bounding-box d-flex align-items-center justify-content-center" style="font-size: 40px; ">{{ total_proveedores }}</p>
          </div>
          <a class="card-footer d-flex justify-content-center" href="{% url 'listar_proveedor'%}"
             style="color: rgb(255, 255, 255);  text-decoration: none; border-radius: 15px; border-color: transparent; ">Listado de Proveedores</a>
        </div>
      </div>
      <!--COUNT DE PRODUCTOS-->
      <div class="col-md-3 mb-3">
        <div class="card  text-white " style="border-radius: 20px; background: #9D5C63">
          <div class="card-body py-5" style="align-content: center; text-align: center;">
            <p style="font-size: 20px;">Total de Productos</p>
            <p class="bi bi-basket2 d-flex align-items-center justify-content-center" style="font-size: 40px; ">{{ total_productos }}</p>
          </div>
          <a class="card-footer d-flex justify-content-center" href="{% url 'listar_producto'%}"
             style="color: rgb(255, 255, 255);  text-decoration: none; border-radius: 15px; border-color: transparent; ">Listado de Productos</a>
        </div>
      </div>
      <!--COUNT DE AGENDAMIENTOS-->
      <div class="col-md-3 mb-3">
        <div class="card  text-white " style="border-radius: 20px;background:#ba542b">
          <div class="card-body py-5" style="align-content: center; text-align: center;">
            <p style="font-size: 20px;">Total de Agendamiento</p>
            <p class="bi bi-list-task d-flex align-items-center justify-content-center" style="font-size: 40px;">{{ total_talleres }}</p>
          </div>
          <a class="card-footer d-flex justify-content-center" href="{% url 'list_taller'%}" 
             style="color: rgb(255, 255, 255);  text-decoration: none; border-radius: 15px; border-color: transparent; ">Listado de Agendamientos</a>
        </div>
      </div>
    </div>
    <hr>
    <!--PRODUCTOS QUE TIENEN UN STOCK <5-->
    <div class="row">
      <div class="col-md-6" >
        <div class="card" >
          <div class="card-body">
            <h3 class="card-title">Productos con Stock menor a 5 unidades </h3>
            <table class="table table-striped table-hover ">
              <thead>
                <tr style="background-color:#1b1b1b ;color: rgb(235, 232, 232);">
                  <th>Nombre del Producto</th>
                  <th>Stock</th>
                </tr>
              </thead>
              <tbody style="border-radius: 20px;">
                {% for producto in productos_bajo_stock %}
                  <tr>
                    <td>{{ producto.0 }}</td><!-- este es el nombre del producto-->
                    <td style="{% if producto.1 <= 5 %}color: red;{% endif %}">{{ producto.1 }}</td><!-- este es el stock-->
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
<!--GRAFICO DE SUMA DE TOTALES DE TIPO DE PAGO-->
      <div class="col-md-6 " >
        <div id="contenedor" class="shadow-lg p-3 mb-5">
          <div class="container-fluid">
            <div class="row">
              <div class="col">
                <table id="exampleGrafico" class="table table-striped table-hover ">
                  <thead>
                    <tr>
                      <th>Tipo de Pago</th>
                      <th>Suma de los Totales</th>
                     </tr>
                  </thead>
                  <tbody style="border-radius: 20px;">
                    {% for tp in suma_totales_por_tipo_pago %}
                      <tr>
                          <td>{{ tp.0 }}</td><!-- este es el TIPO DE PAGO-->
                        <td>{{ tp.1 }}</td><!-- esta es la SUMA DE TOTALES-->
                      </tr>
                    {% endfor %}
                   </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        $(document).ready(function(){
          var table = $("#exampleGrafico").DataTable({
            dom: 'Pfrtip', //P para ver el panel de busqueda
          })
  
          //Grafico con los datos 
          var container = $('#contenedor');
          var chart = Highcharts.chart(container[0],{
                chart: {
                    type: 'pie',
                    plotBackgroundColor: '#F2F2F2',
                    plotBorderWidth: null,
                    plotShadow: false,
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: true,
                                format: '<b>{point.name}</b>: {point.y}',
                                distance: -50,
                                style: {
                                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                                }
                            },
                            showInLegend: true
                        }
                    },
                },
                title:{
                    text: 'Gráfico Suma de Totales por Tipo de Pago'
                },
                tooltip: {
                    valueSuffix: '%'
                },
                series: [
                    {
                        data: chartData(table),
                        dataLabels: {
                            enabled: true, // Asegura que las etiquetas estén habilitadas
                        }
                    }
                ]
          });
          //por cada seleccion del filtro se actualiza los datos del grafico
          table.on('draw', function(){
            chart.series[0].setData(chartData(table));
          });
          //funcion chartData
          function chartData(table){
              var filasAfectadas = {};
              table.column(1, { search: 'applied' }).data().each(function (val){
                if (filasAfectadas[val]) {
                  filasAfectadas[val] += 1;
                } else {
                  filasAfectadas[val] = 1;
                }
              });
  
              return $.map(filasAfectadas, function (cantidad, clave){
                  return{
                    name: clave,
                    y: cantidad
                  };
              });
          }
        });
      </script>
    </div>

<!--AGENDAMIENTOS EN ESTADO ATRASADOS-->
    <div class="row">
      <div class="col-md-12 " >
        <div class="card" >
          <div class="card-body">
            <h3 class="card-title">Agendamientos en Estado <span style="color: red;">ATRASADOS</span></h3>
            <div class="table-responsive">
              <table id="example" class="table table-striped-columns table-hover data-table" style="width: 100% ; font-size: 12px;">
                <thead>
                  <tr style="background-color:#1b1b1b ;color: rgb(235, 232, 232);">
                    <th>Nº</th>
                    <th>Datos del Cliente</th>
                    <th>Modelo de Bicicleta</th>
                    <th>Fecha de Inicio</th>
                    <th>Fecha de Término</th>
                  </tr>
                </thead>
                <tbody>
                  {% for taller in talleres_atrasados_estado %}
                    <tr>
                      <td>{{ taller.id_taller }}</td>
                      <td>{{ taller.cliente_rut_cliente.rut_cliente }} - {{ taller.cliente_rut_cliente.nombre_cliente }} {{ taller.cliente_rut_cliente.apePaterno }} {{ taller.cliente_rut_cliente.apeMaterno }}</td>
                      <td>{{ taller.modelo_bicicleta }}</td>
                      <td>{{ taller.fecha_ingreso }}</td>
                      <td> <span style="color: red;">{{ taller.fecha_termino }}</span></td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}


