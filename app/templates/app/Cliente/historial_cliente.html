{% extends 'app/base.html' %}
{% load humanize %}
{% load static %}
{% block js %}

<script>
   function generarBoletaPDF(id_taller) {
    var clienteData = {};  // Objeto para almacenar datos del cliente
    var tallerData = {};   // Objeto para almacenar datos del taller

    // Iterar sobre las filas y obtener datos del cliente y del taller
    $('#example tbody tr').each(function () {
        var rowData = [];
        var currentId = $(this).find('td:first').text().trim();

        if (currentId === id_taller) {
            // Obtener datos del taller
            $(this).find('td').each(function (index) {
                tallerData[index] = $(this).text().trim();
            });

            // Obtener datos del cliente (suponiendo que la información del cliente está en la primera fila)
            $('#example tbody tr:first').find('td').each(function (index) {
                clienteData[index] = $(this).text().trim();
            });
        }
    });

    // Definir el contenido del PDF
    var contenido = [];
    contenido.push(
        { text: 'BOLETA ELECTRÓNICA', style: 'encabezado' },
        { text: '\n\n' },
        { text: 'Datos del Cliente', style: 'subtitulo' },
        { text: '\n\n' },
        { text: 'Nombre: ' + clienteData[6], style: 'dato' },  // Supongo que el nombre está en la séptima columna
        { text: 'Rut: ' + clienteData[5], style: 'dato' },     // Supongo que el RUT está en la sexta columna
        { text: 'Teléfono: ' + clienteData[7], style: 'dato' },
        { text: 'Correo Electrónico: ' + tallerData[3], style: 'dato' },  // Supongo que el teléfono está en la octava columna
        { text: '\n\n' },
        { text: 'Datos del Taller', style: 'subtitulo' },
        { text: '\n\n' },
        { text: 'Tipo de Arreglo: ' + tallerData[3], style: 'dato' }, 
        { text: 'Modelo de Bicicleta: ' + tallerData[2], style: 'dato' },  // Supongo que el modelo está en la tercera columna
        { text: 'Fecha de Inicio: ' + tallerData[3], style: 'dato' }, 
        { text: 'Fecha de Término: ' + tallerData[3], style: 'dato' },  
        { text: 'Estado del Arreglo: ' + tallerData[3], style: 'dato' }, 
        { text: '\n\n' },
        { text: '----------------------------------------------------------------------------------------------------' },
        { text: '\n\n' },
        { text: 'Total Facturado: ' + tallerData[3], style: 'dato' },     // Supongo que la fecha de inicio está en la cuarta columna
        // Agrega más datos según sea necesario
    );

    // Definir estilos
    var estilos = {
        encabezado: {
            fontSize: 20,
            bold: true,
            alignment: 'center'
        },
        subtitulo: {
            fontSize: 16,
            bold: true
        },
        dato: {
            fontSize: 14
        }
        // Agrega más estilos si es necesario
    };

    // Configurar documento PDF
    var docDefinition = {
        content: contenido,
        styles: estilos
    };

    // Generar PDF
    pdfMake.createPdf(docDefinition).download('boleta.pdf'); // Cambiado de 'open()' a 'download()'
}
</script>

{% endblock %}
{% block contenido %}
{% load crispy_forms_tags %}
<main class="mt-5 pt-3" style="background-color: rgb(255, 255, 255);">
    <div class="container-fluid" style="background-color: rgb(255, 255, 255);">
        <h2>Detalles cliente</h2>
        <hr>
        <div class="row" >
            <div class="col-md-3 mb-3" style="padding-left: 50px;">
                <i class="bi bi-person-bounding-box" style="font-size: 200px;"></i>
            </div>
            <div class="col-md-9 mb-4">
                <div class="card" style="width: 25rem; border-radius: 20px;">
                    <div class="card-body">
                        <div style="flex: 1;">
                            <p><strong>Rut:</strong> {{ cliente.formatted_rut  }}</p>
                            <p><strong>Nombre:</strong> {{ cliente.nombre_cliente }}</p>
                            <p><strong>Apellido Paterno:</strong> {{ cliente.apePaterno }}</p>
                            <p><strong>Apellido Materno:</strong> {{ cliente.apeMaterno }}</p>
                            <p><strong>Correo Electrónico:</strong> {{ cliente.email }}</p>
                            <p><strong>Teléfono:</strong> +569 {{ cliente.fono }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            
            <hr>

            <h2>Detalles de los Arreglos</h2>
            <hr>

            <div class="container-fluid">
                <div class="col-md-12 mb-3" style="padding-top: 10px; padding-bottom: 40px;">
                    <div class="card" style="border-radius: 10px;">
                        <div class="card-header" style="background-color:#3F3F37 ; color: white;">
                            <span><i class="bi bi-table me-2"></i></span> Historial Arreglos
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="example" class="table table-striped-columns table-hover data-table"
                                    style="width: 100%">
                                    <thead>
                                        <tr>
                                            <th>Tipo de Servicio o Arreglo</th>
                                            <th>Fecha inicio</th>
                                            <th>Fecha Término</th>
                                            <th>Modelo Bicicleta</th>
                                            <th>Estado de Arreglo</th>
                                            <th>Total Facturado</th>
                                            <th>Opciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for taller in talleres %}
                                        <tr>
                                            <td>{{ taller.get_tipo_arreglo_display }}</td>
                                            <td>{{ taller.fecha_ingreso }}</td>
                                            <td>{{ taller.fecha_termino }}</td>
                                            <td>{{ taller.modelo_bicicleta |capfirst }}</td>
                                            <td>{{ taller.get_estado_display }}</td>
                                            <td> $ {{ taller.valor | intcomma }}</td>
                                            <td>
                                                <a href="#" onclick="generarBoletaPDF('{{ datos.id_taller }}')" class="btn bi-file-earmark-text btn-secondary btn-md"></a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <a href="{% url 'listar_cliente' %}" class="btn btn-primary btn-sm"
                                style="float: right;">ATRAS</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}
